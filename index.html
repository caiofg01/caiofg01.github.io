<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Ruas</title>
    
    <!-- Metadados para a aplicação web (PWA) -->
    <meta name="theme-color" content="#1F2937">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Rastreador de Ruas","short_name":"Rastreador","start_url":".","display":"standalone","background_color":"#333","theme_color":"#1F2937","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiMxZDRlZDgiPjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUgMS4xMiAyLjUtMi41LTIuNXoiLz48L3N2Zz4=","sizes":"192x192","type":"image/svg+xml"},{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiMxZDRlZDgiPjxwYXRoIGQ9Ik0xMiAyQzguMTMgMiA1IDUuMTMgNSA5YzAgNS4yNSA3IDEzIDcgMTNzNy03Ljc1IDctMTNjMC0zLjg3LTMuMTMtNy03LTd6bTAgOS41Yy0xLjM4IDAtMi41LTEuMTItMi41LTIuNXMxLjEyLTIuNSAyLjUtMi41IDIuNSAxLjEyIDIuNSAyLjUgMS4xMiAyLjUtMi41LTIuNXoiLz48L3N2Zz4=","sizes":"512x512","type":"image/svg+xml"}]}'>


    <!-- Incluindo a biblioteca de mapas Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Incluindo o Tailwind CSS para estilização -->
    <script src="https://cdn/tailwindcss.com"></script>

    <style>
        /* Garante que o mapa ocupe a tela inteira */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita barras de rolagem */
        }
        #map {
            width: 100vw;
            height: 100vh;
            background-color: #333;
        }
        /* Efeito de pulsar no ícone de gravação */
        .recording-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-800">

    <!-- O contêiner do mapa -->
    <div id="map"></div>
    
    <!-- Painel flutuante com informações e o botão -->
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[1000] w-11/12 max-w-md">
        <div id="status-message" class="bg-blue-600 text-white text-center text-sm font-semibold py-2 px-4 rounded-t-lg shadow-lg">
            Aguardando sinal de GPS...
        </div>
        <button id="recordButton" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-b-lg shadow-lg flex items-center justify-center space-x-3 transition-all duration-300 ease-in-out hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-400">
            <div id="recordIcon" class="w-4 h-4 bg-red-500 rounded-full"></div>
            <span>Começar a Gravar</span>
        </button>
    </div>

    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let map;
        let userMarker;
        let currentPolyline; // Linha vermelha para feedback visual em tempo real
        let allTracks = [];
        let isRecording = false;
        let watchId = null;
        let wakeLock = null; // Para manter o ecrã ligado

        // --- ELEMENTOS DA UI ---
        const recordButton = document.getElementById('recordButton');
        const recordButtonText = recordButton.querySelector('span');
        const recordIcon = document.getElementById('recordIcon');
        const statusMessage = document.getElementById('status-message');

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            loadTracksFromStorage();
            setupGeolocation();
            setupServiceWorker(); // Configura o assistente de segundo plano
            
            recordButton.addEventListener('click', toggleRecording);
        });

        // --- SERVICE WORKER (RASTREIO EM SEGUNDO PLANO) ---
        function setupServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.warn("Service Worker não suportado. O rastreio em segundo plano não funcionará.");
                return;
            }

            // O código do Service Worker é definido aqui como uma string
            const serviceWorkerCode = `
                let watchId = null;
                let currentTrackPoints = [];
                
                self.addEventListener('message', (event) => {
                    const { command } = event.data;
                    
                    if (command === 'start') {
                        currentTrackPoints = [];
                        if (!watchId) {
                            const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                            watchId = navigator.geolocation.watchPosition(
                                (position) => {
                                    const { latitude, longitude } = position.coords;
                                    currentTrackPoints.push([latitude, longitude]);
                                },
                                (error) => {
                                    console.error('SW Geolocation Error:', error);
                                },
                                geoOptions
                            );
                        }
                    } else if (command === 'stop') {
                        if (watchId) {
                            navigator.geolocation.clearWatch(watchId);
                            watchId = null;
                        }
                        // Envia os pontos de volta para a página principal
                        if (currentTrackPoints.length > 1) {
                            event.source.postMessage({
                                type: 'track_data',
                                payload: currentTrackPoints
                            });
                        }
                        currentTrackPoints = [];
                    }
                });
            `;

            // Cria um "ficheiro virtual" para o Service Worker
            const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('Service Worker registado com sucesso:', registration))
                .catch(error => console.error('Falha ao registar Service Worker:', error));
            
            // Ouve as mensagens vindas do Service Worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'track_data') {
                    const trackData = event.data.payload;
                    console.log('Trajeto recebido do Service Worker:', trackData);
                    
                    // Adiciona o trajeto final e salva
                    allTracks.push(trackData);
                    localStorage.setItem('myStreetTracks', JSON.stringify(allTracks));
                    
                    // Desenha a linha final no mapa
                    L.polyline(trackData, { color: '#4338ca', weight: 5, opacity: 0.7 }).addTo(map);

                    // Limpa a linha de feedback visual
                    if (currentPolyline) {
                        map.removeLayer(currentPolyline);
                        currentPolyline = null;
                    }
                }
            });
        }


        // --- FUNÇÕES DE WAKE LOCK (MANTER ECRÃ LIGADO) ---
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    statusMessage.textContent = "Gravação iniciada. O ecrã permanecerá ligado.";
                    console.log('Wake Lock ativado!');
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                    statusMessage.textContent = "Não foi possível manter o ecrã ligado.";
                }
            }
        };

        const releaseWakeLock = async () => {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock libertado.');
            }
        };
        
        // --- FUNÇÕES PRINCIPAIS DO MAPA E GEOLOCALIZAÇÃO ---
        function initializeMap() {
            map = L.map('map').setView([-23.5505, -46.6333], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function loadTracksFromStorage() {
            const savedTracks = localStorage.getItem('myStreetTracks');
            if (savedTracks) {
                allTracks = JSON.parse(savedTracks);
                allTracks.forEach(trackData => {
                    if (trackData && trackData.length > 1) {
                        L.polyline(trackData, { color: '#4338ca', weight: 5, opacity: 0.7 }).addTo(map);
                    }
                });
            }
        }

        function setupGeolocation() {
            if (!navigator.geolocation) {
                statusMessage.textContent = 'Geolocalização não é suportada pelo seu navegador.';
                statusMessage.classList.replace('bg-blue-600', 'bg-red-600');
                return;
            }
            watchId = navigator.geolocation.watchPosition(handleLocationSuccess, handleLocationError, {
                enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        function handleLocationSuccess(position) {
            const { latitude, longitude, accuracy } = position.coords;
            const latLng = [latitude, longitude];

            if(!isRecording) {
                 statusMessage.textContent = `Localizado! Precisão: ${accuracy.toFixed(0)}m`;
            }
            statusMessage.classList.replace('bg-red-600', 'bg-blue-600');

            if (!userMarker) {
                userMarker = L.circleMarker(latLng, { 
                  radius: 8, fillColor: "#1d4ed8", color: "#ffffff", weight: 3, opacity: 1, fillOpacity: 1
                }).addTo(map);
                map.setView(latLng, 17);
            } else {
                userMarker.setLatLng(latLng);
            }
            
            // Desenha a linha de feedback visual apenas se a app estiver aberta e a gravar
            if (isRecording) {
                 if (!currentPolyline) {
                    currentPolyline = L.polyline([latLng], { color: 'red', weight: 6 }).addTo(map);
                } else {
                    currentPolyline.addLatLng(latLng);
                }
            }
        }
        
        function handleLocationError(error) {
            console.error("Erro de Geolocalização:", error.code, error.message);
            let userMessage = 'Erro ao obter localização: ';
            switch (error.code) {
                case error.PERMISSION_DENIED: userMessage += "Permissão de localização negada."; break;
                case error.POSITION_UNAVAILABLE: userMessage += "Informação de localização indisponível."; break;
                case error.TIMEOUT: userMessage += "A requisição de localização expirou."; break;
                default: userMessage += "Ocorreu um erro desconhecido."; break;
            }
            statusMessage.textContent = userMessage;
            statusMessage.classList.replace('bg-blue-600', 'bg-red-600');
        }

        function toggleRecording() {
            isRecording = !isRecording;

            if (isRecording) {
                // Inicia a gravação
                recordButtonText.textContent = 'Parar Gravação';
                recordButton.classList.replace('bg-green-600', 'bg-red-600');
                recordIcon.classList.add('recording-pulse');
                
                requestWakeLock(); // Pede para manter o ecrã ligado
                navigator.serviceWorker.controller?.postMessage({ command: 'start' }); // Manda o assistente começar
            } else {
                // Para a gravação
                recordButtonText.textContent = 'Começar a Gravar';
                recordButton.classList.replace('bg-red-600', 'bg-green-600');
                recordIcon.classList.remove('recording-pulse');
                statusMessage.textContent = "Gravação terminada. A processar o trajeto...";

                releaseWakeLock(); // Liberta o ecrã
                navigator.serviceWorker.controller?.postMessage({ command: 'stop' }); // Manda o assistente parar e enviar os dados
            }
        }
    </script>
</body>
</html>

